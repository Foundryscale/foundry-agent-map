<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE GRID — FoundryScale Agent Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@400;500;600;700&family=Chakra+Petch:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ==========================================================================
   THE GRID — FoundryScale Agent Engine Dashboard
   A "Control Room" aesthetic for AI agent operations.
   ========================================================================== */

:root {
  /* --- Base palette --- */
  --base: #060E15;
  --surface: #0B1926;
  --surface-2: #0F2234;
  --border: #1B3A52;
  --border-subtle: #142D42;

  /* --- Brand accent --- */
  --mint: #7ED9B6;
  --mint-glow: rgba(126,217,182,0.12);
  --mint-bright: #A3E8CF;

  /* --- Status colors --- */
  --shipped: #34D399;
  --building: #FBBF24;
  --backlog: #64748B;
  --concept: #A78BFA;
  --urgent: #F87171;

  /* --- Text hierarchy --- */
  --text: #E2EBF3;
  --text-dim: #6B8BA4;
  --text-muted: #3D5A73;

  /* --- Layer colors --- */
  --layer-architect: #60A5FA;
  --layer-builder: #FBBF24;
  --layer-validator: #F87171;
  --layer-pm: #7ED9B6;
  --layer-scout: #2DD4BF;
  --layer-librarian: #A78BFA;
}

/* --- Reset --- */
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: 'Barlow Semi Condensed', sans-serif;
  background: var(--base);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  /* Dot grid texture echoing "THE GRID" */
  background-image: radial-gradient(circle, rgba(126,217,182,0.03) 1px, transparent 1px);
  background-size: 28px 28px;
}

/* --- Scrollbar --- */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* --- Font helpers --- */
.font-display { font-family: 'Chakra Petch', sans-serif; }
.font-label { font-family: 'Barlow Semi Condensed', sans-serif; }
.font-mono { font-family: 'JetBrains Mono', monospace; }

/* ==========================================================================
   KEYFRAMES
   ========================================================================== */

@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

@keyframes pulseLive {
  0%, 100% { box-shadow: 0 0 0 0 rgba(52,211,153,0.5); }
  50%      { box-shadow: 0 0 0 6px rgba(52,211,153,0); }
}

@keyframes pulseGlow {
  0%, 100% { opacity: 0.3; }
  50%      { opacity: 0.6; }
}

@keyframes spin360 {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

@keyframes gradientShift {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes shimmerLoad {
  0%   { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

@keyframes countPulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes slideInRight {
  from { transform: translateX(100%); }
  to   { transform: translateX(0); }
}
@keyframes slideOutRight {
  from { transform: translateX(0); }
  to   { transform: translateX(100%); }
}
@keyframes slideInUp {
  from { transform: translateY(20px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
@keyframes fadeOverlay {
  from { opacity: 0; }
  to   { opacity: 1; }
}
@keyframes typingDot {
  0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ==========================================================================
   HEADER
   ========================================================================== */

.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: linear-gradient(180deg, var(--base) 0%, var(--base) 70%, rgba(6,14,21,0) 100%);
  padding: 16px 24px 0;
}

.header-inner {
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 16px;
  padding-bottom: 16px;
}

.header-brand {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.header-company {
  font-family: 'Chakra Petch', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.header-title {
  font-family: 'Chakra Petch', sans-serif;
  font-size: 38px;
  font-weight: 700;
  color: #fff;
  line-height: 1;
  text-shadow: 0 0 30px rgba(126,217,182,0.25), 0 0 60px rgba(126,217,182,0.08);
  animation: pulseGlow 2s ease-in-out infinite;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: 14px;
  padding-bottom: 6px;
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 7px;
}

.live-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--shipped);
  animation: pulseLive 2s infinite;
  flex-shrink: 0;
}

.live-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  color: var(--shipped);
  letter-spacing: 0.08em;
}

.header-sep {
  width: 1px;
  height: 20px;
  background: var(--border);
}

.last-updated {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

.refresh-btn {
  width: 34px;
  height: 34px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-dim);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border-color 0.2s, color 0.2s, background 0.2s;
}

.refresh-btn:hover {
  border-color: var(--mint);
  color: var(--mint);
  background: var(--surface-2);
}

.refresh-btn.spinning .refresh-icon {
  animation: spin360 0.8s linear infinite;
}

.refresh-icon {
  width: 16px;
  height: 16px;
  display: block;
}

/* Gradient line below header */
.header-line {
  height: 2px;
  max-width: 1600px;
  margin: 0 auto;
  background: linear-gradient(90deg, var(--mint), rgba(126,217,182,0.3), transparent, rgba(126,217,182,0.3), var(--mint));
  background-size: 200% 100%;
  animation: gradientShift 6s ease-in-out infinite;
  border-radius: 1px;
}

/* ==========================================================================
   DASHBOARD CONTAINER
   ========================================================================== */

.dashboard {
  max-width: 1600px;
  margin: 0 auto;
  padding: 24px 24px 40px;
}

/* ==========================================================================
   SECTION TITLES
   ========================================================================== */

.section-title {
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 16px;
  padding-left: 2px;
}

/* ==========================================================================
   METRICS RIBBON
   ========================================================================== */

.metrics-ribbon {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  margin-bottom: 32px;
}

@media (max-width: 1000px) {
  .metrics-ribbon { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 600px) {
  .metrics-ribbon { grid-template-columns: repeat(2, 1fr); }
}

.metric-card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  padding: 16px 18px 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.25s;
}

.metric-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--metric-accent, var(--mint));
  border-radius: 10px 10px 0 0;
}

.metric-card:hover {
  border-color: var(--border);
}

.metric-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 38px;
  font-weight: 700;
  line-height: 1;
  color: var(--metric-accent, var(--mint));
}

.metric-label {
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-dim);
}

/* Skeleton loading state for metrics */
.metric-value.skeleton {
  width: 60px;
  height: 38px;
  background: linear-gradient(90deg, var(--surface-2) 25%, var(--border-subtle) 50%, var(--surface-2) 75%);
  background-size: 200% 100%;
  animation: shimmerLoad 1.5s infinite;
  border-radius: 4px;
  color: transparent !important;
}

/* ==========================================================================
   GRID LAYERS
   ========================================================================== */

.grid-layers {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
  margin-bottom: 36px;
}

.layer-card {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-left: 4px solid var(--layer-color, var(--mint));
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(12px);
  transition: border-color 0.25s, box-shadow 0.3s;
}

.layer-card.visible {
  animation: fadeSlideIn 0.3s ease-out forwards;
}

.layer-card:hover {
  border-color: var(--layer-color, var(--mint));
  box-shadow: 0 0 20px rgba(126,217,182,0.06), inset 0 0 20px rgba(126,217,182,0.02);
}

.layer-head {
  padding: 14px 16px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.layer-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--layer-color, var(--mint));
  flex-shrink: 0;
}

.layer-name {
  font-family: 'Chakra Petch', sans-serif;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--text);
  flex: 1;
  min-width: 0;
}

.layer-stat {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-dim);
  flex-shrink: 0;
}

.layer-items {
  padding: 6px 10px 10px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  max-height: 220px;
  overflow-y: auto;
  flex: 1;
}

.layer-empty {
  padding: 20px 16px;
  text-align: center;
  font-size: 13px;
  color: var(--text-muted);
  font-style: italic;
}

/* Task row inside layer cards */
.layer-task {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 6px;
  text-decoration: none;
  color: inherit;
  transition: background 0.15s;
}

.layer-task:hover {
  background: var(--surface-2);
}

.layer-task-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.layer-task-name {
  font-size: 13px;
  font-weight: 500;
  flex: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.layer-task-status {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  white-space: nowrap;
  flex-shrink: 0;
}

/* Status pill variations */
.pill-shipped {
  background: rgba(52,211,153,0.12);
  color: var(--shipped);
  box-shadow: inset 0 0 6px rgba(52,211,153,0.08);
}

.pill-building {
  background: rgba(251,191,36,0.12);
  color: var(--building);
  box-shadow: inset 0 0 6px rgba(251,191,36,0.08);
}

.pill-backlog {
  background: rgba(100,116,139,0.15);
  color: var(--backlog);
  box-shadow: inset 0 0 6px rgba(100,116,139,0.06);
}

.pill-concept {
  background: rgba(167,139,250,0.12);
  color: var(--concept);
  box-shadow: inset 0 0 6px rgba(167,139,250,0.08);
}

.pill-default {
  background: rgba(61,90,115,0.2);
  color: var(--text-dim);
}

/* ==========================================================================
   BUILD PIPELINE
   ========================================================================== */

.pipeline-section {
  margin-bottom: 36px;
}

.pipeline-table {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  overflow: hidden;
}

.pipeline-head {
  display: grid;
  grid-template-columns: 32px 1fr 110px 80px 44px;
  gap: 10px;
  padding: 10px 18px;
  border-bottom: 1px solid var(--border-subtle);
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.pipeline-body {
  max-height: 400px;
  overflow-y: auto;
}

.pipeline-row {
  display: grid;
  grid-template-columns: 32px 1fr 110px 80px 44px;
  gap: 10px;
  padding: 10px 18px;
  border-bottom: 1px solid var(--border-subtle);
  align-items: center;
  text-decoration: none;
  color: inherit;
  transition: background 0.15s, border-color 0.2s;
}

.pipeline-row:last-child {
  border-bottom: none;
}

.pipeline-row:hover {
  background: var(--surface-2);
}

/* Priority dot */
.pri-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  justify-self: center;
}

.pri-urgent { background: var(--urgent); }
.pri-high   { background: var(--building); }
.pri-normal { background: var(--mint); }
.pri-low    { background: var(--backlog); }

.pipeline-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.pipeline-date {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
}

.pipeline-link {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid var(--border-subtle);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  justify-self: center;
  transition: border-color 0.2s, background 0.2s;
}

.pipeline-row:hover .pipeline-link {
  border-color: var(--mint);
  background: var(--mint-glow);
}

.pipeline-link-arrow {
  width: 12px;
  height: 12px;
  display: block;
  stroke: var(--text-dim);
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.pipeline-row:hover .pipeline-link-arrow {
  stroke: var(--mint);
}

@media (max-width: 700px) {
  .pipeline-head,
  .pipeline-row {
    grid-template-columns: 32px 1fr 90px;
  }
  .pipeline-head > :nth-child(4),
  .pipeline-head > :nth-child(5),
  .pipeline-row > :nth-child(4),
  .pipeline-row > :nth-child(5) {
    display: none;
  }
}

/* ==========================================================================
   BOTTOM TWO-COLUMN SECTION
   ========================================================================== */

.bottom-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 36px;
}

@media (max-width: 900px) {
  .bottom-grid {
    grid-template-columns: 1fr;
  }
}

/* --- Recent Activity --- */
.activity-panel {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.activity-list {
  max-height: 440px;
  overflow-y: auto;
  flex: 1;
  position: relative;
}

/* Vertical timeline line */
.activity-list::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 26px;
  width: 1px;
  background: var(--border-subtle);
  z-index: 0;
}

.activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 18px;
  border-bottom: 1px solid var(--border-subtle);
  text-decoration: none;
  color: inherit;
  transition: background 0.15s;
  position: relative;
  z-index: 1;
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-item:hover {
  background: var(--surface-2);
}

.activity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  z-index: 2;
  border: 2px solid var(--surface);
  box-shadow: 0 0 0 1px var(--border-subtle);
}

.activity-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.activity-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.activity-status-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.activity-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
  white-space: nowrap;
}

/* --- Content Pipeline --- */
.content-panel {
  background: var(--surface);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.content-section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 18px;
  border-bottom: 1px solid var(--border-subtle);
}

.content-section-label {
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--text-dim);
}

.content-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--surface-2);
  color: var(--text-dim);
}

.content-items {
  max-height: 200px;
  overflow-y: auto;
}

.content-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 18px;
  border-bottom: 1px solid var(--border-subtle);
  text-decoration: none;
  color: inherit;
  transition: background 0.15s;
}

.content-item:last-child {
  border-bottom: none;
}

.content-item:hover {
  background: var(--surface-2);
}

.content-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.content-name {
  font-size: 13px;
  font-weight: 500;
  flex: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.content-status {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  white-space: nowrap;
  flex-shrink: 0;
}

/* ==========================================================================
   PANEL HEADER (reusable for Activity + Content panels)
   ========================================================================== */

.panel-header {
  padding: 14px 18px 12px;
  border-bottom: 1px solid var(--border-subtle);
}

.panel-title {
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--text-muted);
}

/* ==========================================================================
   FOOTER
   ========================================================================== */

.footer {
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px 24px 24px;
  text-align: center;
  border-top: 1px solid var(--border-subtle);
}

.footer-text {
  font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 12px;
  color: var(--text-muted);
  letter-spacing: 0.04em;
}

.footer-refresh {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
  letter-spacing: 0.04em;
}

/* ==========================================================================
   SETUP / ERROR PANEL
   ========================================================================== */

.setup-panel {
  max-width: 520px;
  margin: 80px auto;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 40px 36px;
  text-align: center;
}

.setup-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: var(--mint-glow);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
}

/* CSS-drawn lightning bolt shape */
.setup-icon::after {
  content: '';
  display: block;
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 14px solid var(--mint);
}

.setup-title {
  font-family: 'Chakra Petch', sans-serif;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--text);
}

.setup-desc {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 24px;
  line-height: 1.6;
}

.setup-steps {
  text-align: left;
  background: var(--surface-2);
  border-radius: 10px;
  padding: 20px 24px;
  margin-bottom: 20px;
}

.setup-steps ol {
  list-style: none;
  counter-reset: step;
}

.setup-steps li {
  counter-increment: step;
  font-size: 13px;
  color: var(--text-dim);
  padding: 6px 0 6px 32px;
  position: relative;
  line-height: 1.5;
}

.setup-steps li::before {
  content: counter(step);
  position: absolute;
  left: 0;
  top: 6px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--surface);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  color: var(--text-muted);
  text-align: center;
  line-height: 22px;
}

.setup-steps code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  background: var(--surface);
  padding: 1px 6px;
  border-radius: 4px;
  color: var(--mint);
}

.setup-endpoint {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 8px;
}

/* ==========================================================================
   EMPTY STATE
   ========================================================================== */

.empty-message {
  padding: 28px 18px;
  text-align: center;
  font-size: 13px;
  color: var(--text-muted);
}

/* ==========================================================================
   UTILITY
   ========================================================================== */

.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
}

/* ==========================================================================
   CHAT FAB + PANEL
   ========================================================================== */

.chat-fab {
  position: fixed; bottom: 24px; right: 24px;
  width: 56px; height: 56px; border-radius: 50%;
  background: var(--mint); border: none; cursor: pointer;
  z-index: 200; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(126,217,182,0.35), 0 0 40px rgba(126,217,182,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}
.chat-fab:hover { transform: scale(1.08); box-shadow: 0 6px 28px rgba(126,217,182,0.45); }
.chat-fab svg { width: 24px; height: 24px; stroke: var(--base); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

.chat-panel {
  position: fixed; bottom: 24px; right: 24px;
  width: 420px; height: 580px; max-height: calc(100vh - 48px);
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  z-index: 210; display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 80px rgba(126,217,182,0.06);
  animation: slideInUp 0.25s ease-out;
}

.chat-header {
  padding: 14px 16px; border-bottom: 1px solid var(--border-subtle);
  display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.chat-header-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--mint); animation: pulseLive 2s infinite; flex-shrink: 0; }
.chat-header-title { font-family: 'Chakra Petch', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; color: var(--text); flex: 1; }
.chat-close {
  width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border-subtle);
  background: transparent; color: var(--text-dim); cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: border-color 0.2s, color 0.2s; flex-shrink: 0;
}
.chat-close:hover { border-color: var(--urgent); color: var(--urgent); }

.chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.chat-msg { max-width: 88%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.55; word-break: break-word; }
.chat-msg-human { align-self: flex-end; background: rgba(126,217,182,0.12); border: 1px solid rgba(126,217,182,0.2); color: var(--text); border-bottom-right-radius: 4px; }
.chat-msg-agent { align-self: flex-start; background: var(--surface-2); border: 1px solid var(--border-subtle); color: var(--text); border-bottom-left-radius: 4px; }
.chat-msg-time { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 4px; }
.chat-msg-agent .chat-msg-content { white-space: pre-wrap; }
.chat-msg-agent .chat-msg-content strong { color: var(--mint); font-weight: 600; }

.chat-typing { align-self: flex-start; display: flex; gap: 5px; padding: 12px 16px; background: var(--surface-2); border: 1px solid var(--border-subtle); border-radius: 12px; border-bottom-left-radius: 4px; }
.chat-typing span { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
.chat-typing span:nth-child(1) { animation: typingDot 1.4s infinite 0s; }
.chat-typing span:nth-child(2) { animation: typingDot 1.4s infinite 0.2s; }
.chat-typing span:nth-child(3) { animation: typingDot 1.4s infinite 0.4s; }

.chat-input-area { padding: 12px 16px; border-top: 1px solid var(--border-subtle); display: flex; gap: 8px; align-items: flex-end; flex-shrink: 0; }
.chat-input {
  flex: 1; min-height: 38px; max-height: 120px; padding: 8px 12px;
  background: var(--base); border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); font-family: 'Barlow Semi Condensed', sans-serif; font-size: 13px; line-height: 1.5;
  resize: none; outline: none; transition: border-color 0.2s;
}
.chat-input:focus { border-color: var(--mint); }
.chat-input::placeholder { color: var(--text-muted); }

.chat-send {
  width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--mint);
  background: rgba(126,217,182,0.1); color: var(--mint); cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: background 0.2s, opacity 0.2s; flex-shrink: 0;
}
.chat-send:hover { background: rgba(126,217,182,0.2); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
.chat-send svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

.chat-welcome { text-align: center; padding: 24px 16px; }
.chat-welcome-title { font-family: 'Chakra Petch', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
.chat-welcome-desc { font-size: 13px; color: var(--text-dim); line-height: 1.5; margin-bottom: 14px; }
.chat-suggestions { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
.chat-chip {
  padding: 6px 12px; background: var(--surface-2); border: 1px solid var(--border-subtle); border-radius: 8px;
  font-size: 12px; color: var(--text-dim); cursor: pointer; transition: border-color 0.2s, color 0.2s;
}
.chat-chip:hover { border-color: var(--mint); color: var(--mint); }

@media (max-width: 500px) {
  .chat-panel { width: calc(100vw - 16px); right: 8px; bottom: 8px; height: calc(100vh - 16px); max-height: none; border-radius: 12px; }
}

/* ==========================================================================
   AGENT DETAIL DRAWER
   ========================================================================== */

.drawer-backdrop {
  position: fixed; inset: 0; background: rgba(6,14,21,0.75); z-index: 150;
  animation: fadeOverlay 0.2s ease-out;
}
.agent-drawer {
  position: fixed; top: 0; right: 0; width: 440px; max-width: 90vw; height: 100vh;
  background: var(--surface); border-left: 1px solid var(--border); z-index: 160;
  display: flex; flex-direction: column; overflow: hidden;
  animation: slideInRight 0.25s ease-out;
}
.agent-drawer.closing { animation: slideOutRight 0.2s ease-in forwards; }

.drawer-header {
  padding: 20px 20px 16px; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; position: relative;
}
.drawer-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--drawer-accent, var(--mint)); }
.drawer-header-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 8px; }
.drawer-layer-badge { font-family: 'Barlow Semi Condensed', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); }
.drawer-title { font-family: 'Chakra Petch', sans-serif; font-size: 17px; font-weight: 700; color: var(--text); line-height: 1.3; flex: 1; }
.drawer-close {
  width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border);
  background: transparent; color: var(--text-dim); cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: border-color 0.2s, color 0.2s; flex-shrink: 0;
}
.drawer-close:hover { border-color: var(--urgent); color: var(--urgent); }

.drawer-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
.drawer-body::-webkit-scrollbar { width: 4px; }
.drawer-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.drawer-field {}
.drawer-label { font-family: 'Barlow Semi Condensed', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
.drawer-value { font-size: 14px; color: var(--text); line-height: 1.5; }

.drawer-status {
  display: inline-block; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 600;
  padding: 3px 10px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.04em;
}
.drawer-priority { display: inline-flex; align-items: center; gap: 6px; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--text); text-transform: capitalize; }
.drawer-pri-dot { width: 8px; height: 8px; border-radius: 50%; }

.drawer-assignees { display: flex; flex-wrap: wrap; gap: 6px; }
.drawer-assignee-chip { font-family: 'JetBrains Mono', monospace; font-size: 11px; padding: 3px 10px; border-radius: 6px; background: var(--surface-2); border: 1px solid var(--border-subtle); color: var(--text-dim); }

.drawer-dates { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.drawer-desc {
  font-size: 13px; color: var(--text-dim); line-height: 1.6; white-space: pre-wrap;
  max-height: 200px; overflow-y: auto; padding: 10px 12px;
  background: var(--base); border: 1px solid var(--border-subtle); border-radius: 8px;
}

.drawer-subtasks { display: flex; flex-direction: column; }
.drawer-subtask { display: flex; align-items: center; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--border-subtle); }
.drawer-subtask:last-child { border-bottom: none; }
.drawer-sub-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.drawer-sub-name { font-size: 13px; color: var(--text); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.drawer-sub-status { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; flex-shrink: 0; }

.drawer-tags { display: flex; flex-wrap: wrap; gap: 6px; }
.drawer-tag { font-size: 11px; padding: 3px 10px; border-radius: 6px; background: rgba(126,217,182,0.08); border: 1px solid rgba(126,217,182,0.15); color: var(--mint); }

.drawer-skeleton { height: 14px; background: linear-gradient(90deg, var(--surface-2) 25%, var(--border-subtle) 50%, var(--surface-2) 75%); background-size: 200% 100%; animation: shimmerLoad 1.5s infinite; border-radius: 4px; }

.drawer-footer {
  padding: 14px 20px; border-top: 1px solid var(--border-subtle); display: flex; gap: 8px; flex-shrink: 0;
}
.drawer-btn {
  padding: 8px 16px; border-radius: 8px; font-family: 'Barlow Semi Condensed', sans-serif;
  font-size: 13px; font-weight: 600; letter-spacing: 0.04em; cursor: pointer; transition: background 0.2s, border-color 0.2s;
  text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
}
.drawer-btn-primary { background: rgba(126,217,182,0.12); border: 1px solid var(--mint); color: var(--mint); }
.drawer-btn-primary:hover { background: rgba(126,217,182,0.2); }
.drawer-btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
.drawer-btn-secondary:hover { border-color: var(--text-dim); color: var(--text); }

.hidden { display: none !important; }
</style>
</head>
<body>

<!-- ====================================================================
     HEADER
     ==================================================================== -->
<div class="header">
  <div class="header-inner">
    <div class="header-brand">
      <div class="header-company">FOUNDRYSCALE</div>
      <div class="header-title">THE GRID</div>
    </div>
    <div class="header-controls">
      <div class="live-indicator">
        <span class="live-dot" id="liveDot"></span>
        <span class="live-label" id="liveLabel">CONNECTING</span>
      </div>
      <span class="header-sep"></span>
      <span class="last-updated font-mono" id="lastUpdated">--:--</span>
      <button class="refresh-btn" id="refreshBtn" title="Refresh data">
        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"></polyline>
          <polyline points="1 20 1 14 7 14"></polyline>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
      </button>
    </div>
  </div>
  <div class="header-line"></div>
</div>

<!-- ====================================================================
     DASHBOARD CONTENT
     ==================================================================== -->
<div class="dashboard" id="dashboardContent">

  <!-- Metrics Ribbon -->
  <div class="metrics-ribbon" id="metricsRibbon">
    <div class="metric-card" style="--metric-accent: var(--mint)">
      <div class="metric-value skeleton font-mono" id="metricAgents">--</div>
      <div class="metric-label">AGENTS</div>
    </div>
    <div class="metric-card" style="--metric-accent: var(--shipped)">
      <div class="metric-value skeleton font-mono" id="metricShipped">--</div>
      <div class="metric-label">SHIPPED</div>
    </div>
    <div class="metric-card" style="--metric-accent: var(--building)">
      <div class="metric-value skeleton font-mono" id="metricBuilding">--</div>
      <div class="metric-label">BUILDING</div>
    </div>
    <div class="metric-card" style="--metric-accent: var(--backlog)">
      <div class="metric-value skeleton font-mono" id="metricBacklog">--</div>
      <div class="metric-label">BACKLOG</div>
    </div>
    <div class="metric-card" style="--metric-accent: var(--mint)">
      <div class="metric-value skeleton font-mono" id="metricSprint">--</div>
      <div class="metric-label">SPRINT</div>
    </div>
    <div class="metric-card" style="--metric-accent: var(--concept)">
      <div class="metric-value skeleton font-mono" id="metricContent">--</div>
      <div class="metric-label">CONTENT</div>
    </div>
  </div>

  <!-- GRID Layers -->
  <div class="section-title">GRID LAYERS</div>
  <div class="grid-layers" id="gridLayers"></div>

  <!-- Build Pipeline -->
  <div class="pipeline-section" id="pipelineSection">
    <div class="section-title">BUILD PIPELINE</div>
    <div class="pipeline-table">
      <div class="pipeline-head">
        <div></div>
        <div>Task</div>
        <div>Status</div>
        <div>Due</div>
        <div></div>
      </div>
      <div class="pipeline-body" id="pipelineBody"></div>
    </div>
  </div>

  <!-- Bottom two-column section -->
  <div class="bottom-grid">

    <!-- Recent Activity -->
    <div class="activity-panel">
      <div class="panel-header">
        <div class="panel-title">RECENT ACTIVITY</div>
      </div>
      <div class="activity-list" id="activityList"></div>
    </div>

    <!-- Content Pipeline -->
    <div class="content-panel" id="contentPanel">
      <div class="panel-header">
        <div class="panel-title">CONTENT PIPELINE</div>
      </div>
      <div id="contentSections"></div>
    </div>

  </div>

</div>

<!-- ====================================================================
     SETUP PANEL (shown when data unavailable)
     ==================================================================== -->
<div id="setupPanel" style="display:none;">
  <div class="setup-panel">
    <div class="setup-icon"></div>
    <div class="setup-title">Dashboard Setup Required</div>
    <div class="setup-desc">
      This dashboard needs an n8n webhook workflow to pull live data from ClickUp.
    </div>
    <div class="setup-steps">
      <ol>
        <li>Import the workflow file: <code>workflows/grid-dashboard-data.json</code></li>
        <li>Open your n8n instance: <code>https://cprojects1.app.n8n.cloud</code></li>
        <li>Update the ClickUp API key in the Code node</li>
        <li>Activate the workflow</li>
        <li>Refresh this page</li>
      </ol>
    </div>
    <div class="setup-endpoint">
      Webhook: <code>/webhook/grid-dashboard</code>
    </div>
  </div>
</div>

<!-- ====================================================================
     FOOTER
     ==================================================================== -->
<div class="footer">
  <div class="footer-text">Powered by FoundryScale &times; n8n &times; ClickUp</div>
  <div class="footer-refresh">Refreshes every 5m</div>
</div>

<!-- Chat FAB -->
<button class="chat-fab" id="chatFab" title="Open GRID Agent">
  <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<!-- Chat Panel -->
<div class="chat-panel hidden" id="chatPanel">
  <div class="chat-header">
    <span class="chat-header-dot"></span>
    <span class="chat-header-title font-display">GRID AGENT</span>
    <button class="chat-close" id="chatClose" title="Close">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <textarea class="chat-input" id="chatInput" placeholder="Ask about THE GRID..." rows="1"></textarea>
    <button class="chat-send" id="chatSend" title="Send">
      <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- Agent Detail Drawer -->
<div class="drawer-backdrop hidden" id="drawerBackdrop"></div>
<div class="agent-drawer hidden" id="agentDrawer">
  <div class="drawer-header" id="drawerHeader">
    <div class="drawer-header-top">
      <div>
        <div class="drawer-layer-badge" id="drawerLayerBadge"></div>
        <div class="drawer-title" id="drawerTitle">--</div>
      </div>
      <button class="drawer-close" id="drawerClose" title="Close">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
  <div class="drawer-footer">
    <button class="drawer-btn drawer-btn-primary" id="drawerAskBtn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Ask About This
    </button>
    <a class="drawer-btn drawer-btn-secondary" id="drawerClickupLink" href="#" target="_blank" rel="noopener">
      Open in ClickUp
    </a>
  </div>
</div>

<!-- ====================================================================
     JAVASCRIPT — Vanilla, production-grade, no external deps
     ==================================================================== -->
<script>
(function() {
  'use strict';

  /* ================================================================
     CONFIGURATION
     ================================================================ */

  var CONFIG = {
    WEBHOOK_URL: 'https://cprojects1.app.n8n.cloud/webhook/grid-dashboard?token=grid_fndry_7kX9mP2qR4wL',
    CHAT_WEBHOOK_URL: 'https://cprojects1.app.n8n.cloud/webhook/grid-chat',
    DETAIL_WEBHOOK_URL: 'https://cprojects1.app.n8n.cloud/webhook/grid-agent-detail',
    CHAT_TOKEN: 'grid_fndry_7kX9mP2qR4wL',
    CHAT_STORAGE_KEY: 'grid_chat_history',
    CHAT_MAX_HISTORY: 50,
    REFRESH_INTERVAL: 300000,
    CLICKUP_WORKSPACE: 'https://app.clickup.com/9014775277'
  };

  /* ================================================================
     LAYER DEFINITIONS
     Each layer maps to a key in the API response "layers" object.
     ================================================================ */

  var LAYERS = [
    { key: 'architect',  num: '01', name: 'ARCHITECT',  color: 'var(--layer-architect)',  hex: '#60A5FA' },
    { key: 'builder',    num: '02', name: 'BUILDER',    color: 'var(--layer-builder)',    hex: '#FBBF24' },
    { key: 'validator',  num: '03', name: 'VALIDATOR',  color: 'var(--layer-validator)',  hex: '#F87171' },
    { key: 'pm',         num: '04', name: 'PM',         color: 'var(--layer-pm)',         hex: '#7ED9B6' },
    { key: 'scout',      num: '05', name: 'SCOUT',      color: 'var(--layer-scout)',      hex: '#2DD4BF' },
    { key: 'librarian',  num: '06', name: 'LIBRARIAN',  color: 'var(--layer-librarian)',  hex: '#A78BFA' }
  ];

  /* ================================================================
     STATE
     ================================================================ */

  var refreshTimer = null;
  var dashboardData = null;
  var hasAnimatedCounters = false;
  var chatOpen = false;
  var chatSending = false;
  var chatHistory = [];
  var currentDrawerTask = null;

  /* ================================================================
     UTILITY FUNCTIONS
     ================================================================ */

  /**
   * Convert a Unix millisecond timestamp to a relative time string.
   * Handles string and number inputs, and timestamps in seconds.
   */
  function formatTimeAgo(timestamp) {
    if (!timestamp) return '--';
    var ts = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;
    if (isNaN(ts)) return '--';
    /* Convert seconds to milliseconds if needed */
    if (ts < 1e12) ts = ts * 1000;
    var now = Date.now();
    var diff = now - ts;
    if (diff < 0) return 'just now';
    var secs = Math.floor(diff / 1000);
    if (secs < 60) return 'just now';
    var mins = Math.floor(secs / 60);
    if (mins < 60) return mins + 'm ago';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    var days = Math.floor(hrs / 24);
    if (days < 30) return days + 'd ago';
    var months = Math.floor(days / 30);
    return months + 'mo ago';
  }

  /**
   * Format a Unix ms timestamp to "Feb 25" style date.
   */
  function formatDate(timestamp) {
    if (!timestamp) return '--';
    var ts = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;
    if (isNaN(ts)) return '--';
    if (ts < 1e12) ts = ts * 1000;
    var d = new Date(ts);
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate();
  }

  /**
   * Map a status string to the appropriate CSS pill class.
   */
  function getStatusPillClass(status) {
    if (!status) return 'pill-default';
    var s = status.toLowerCase().trim();
    if (['shipped','complete','done','closed'].some(function(k) { return s.indexOf(k) !== -1; })) return 'pill-shipped';
    if (['in progress','building','in review'].some(function(k) { return s.indexOf(k) !== -1; })) return 'pill-building';
    if (['backlog','open','to do','todo','planned'].some(function(k) { return s.indexOf(k) !== -1; })) return 'pill-backlog';
    if (['concept','idea','draft'].some(function(k) { return s.indexOf(k) !== -1; })) return 'pill-concept';
    return 'pill-default';
  }

  /**
   * Map a status string to its CSS custom property color.
   */
  function getStatusColor(status) {
    var cls = getStatusPillClass(status);
    var map = {
      'pill-shipped':  'var(--shipped)',
      'pill-building': 'var(--building)',
      'pill-backlog':  'var(--backlog)',
      'pill-concept':  'var(--concept)',
      'pill-default':  'var(--text-muted)'
    };
    return map[cls] || 'var(--text-muted)';
  }

  /**
   * Map priority to a CSS class for the colored dot.
   */
  function getPriorityClass(priority) {
    if (!priority) return 'pri-normal';
    var p = (typeof priority === 'object') ? (priority.priority || '') : String(priority);
    var pl = p.toLowerCase();
    if (pl === 'urgent' || pl === '1') return 'pri-urgent';
    if (pl === 'high' || pl === '2') return 'pri-high';
    if (pl === 'normal' || pl === '3') return 'pri-normal';
    return 'pri-low';
  }

  /**
   * Animate a number from 0 to target on an element.
   * Uses requestAnimationFrame for smooth 60fps animation.
   */
  function countUp(element, target, duration) {
    if (typeof target !== 'number' || isNaN(target)) {
      element.textContent = target || '--';
      return;
    }
    var start = 0;
    var startTime = null;
    duration = duration || 800;

    function step(currentTime) {
      if (!startTime) startTime = currentTime;
      var progress = Math.min((currentTime - startTime) / duration, 1);
      /* Ease-out curve for smooth deceleration */
      var eased = 1 - Math.pow(1 - progress, 3);
      var current = Math.floor(eased * target);
      element.textContent = current;
      if (progress < 1) {
        requestAnimationFrame(step);
      } else {
        element.textContent = target;
      }
    }

    requestAnimationFrame(step);
  }

  /* ================================================================
     SAFE DOM HELPERS
     All rendering uses createElement + textContent, never innerHTML.
     ================================================================ */

  function clearElement(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  function el(tag, className, textContent) {
    var node = document.createElement(tag);
    if (className) node.className = className;
    if (textContent !== undefined && textContent !== null) node.textContent = textContent;
    return node;
  }

  /* ================================================================
     FETCH DATA
     ================================================================ */

  function fetchDashboardData() {
    var btn = document.getElementById('refreshBtn');
    btn.classList.add('spinning');

    fetch(CONFIG.WEBHOOK_URL, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    })
    .then(function(resp) {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return resp.json();
    })
    .then(function(data) {
      /* API may wrap payload in an array */
      if (Array.isArray(data)) data = data[0];
      dashboardData = data;
      renderDashboard(data);
      showDashboard();
      updateLiveStatus(true);
      updateLastUpdated();
    })
    .catch(function(err) {
      if (!dashboardData) showSetup();
      updateLiveStatus(false);
    })
    .finally(function() {
      btn.classList.remove('spinning');
    });
  }

  function manualRefresh() {
    fetchDashboardData();
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(fetchDashboardData, CONFIG.REFRESH_INTERVAL);
  }

  /* ================================================================
     VISIBILITY TOGGLES
     ================================================================ */

  function showDashboard() {
    document.getElementById('dashboardContent').style.display = '';
    document.getElementById('setupPanel').style.display = 'none';
  }

  function showSetup() {
    document.getElementById('dashboardContent').style.display = 'none';
    document.getElementById('setupPanel').style.display = '';
  }

  function updateLiveStatus(connected) {
    var dot = document.getElementById('liveDot');
    var label = document.getElementById('liveLabel');
    if (connected) {
      dot.style.background = 'var(--shipped)';
      dot.style.animation = 'pulseLive 2s infinite';
      label.textContent = 'LIVE';
      label.style.color = 'var(--shipped)';
    } else {
      dot.style.background = 'var(--urgent)';
      dot.style.animation = 'none';
      label.textContent = 'OFFLINE';
      label.style.color = 'var(--urgent)';
    }
  }

  function updateLastUpdated() {
    var now = new Date();
    document.getElementById('lastUpdated').textContent =
      'Updated ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
  }

  /* ================================================================
     RENDER ORCHESTRATOR
     ================================================================ */

  function renderDashboard(data) {
    renderMetrics(data.stats || {});
    renderGridLayers(data.layers || {});
    renderPipeline(data.buildPipeline || []);
    renderActivity(data.recentActivity || []);
    renderContent(data.content || {});
  }

  /* ================================================================
     RENDER: Metrics Ribbon
     ================================================================ */

  function renderMetrics(stats) {
    var fields = [
      { id: 'metricAgents',   value: stats.totalAgents },
      { id: 'metricShipped',  value: stats.shipped },
      { id: 'metricBuilding', value: stats.building },
      { id: 'metricBacklog',  value: stats.backlog },
      { id: 'metricSprint',   value: null, sprint: true },
      { id: 'metricContent',  value: stats.contentPipeline }
    ];

    fields.forEach(function(f) {
      var element = document.getElementById(f.id);
      element.classList.remove('skeleton');

      if (f.sprint) {
        /* Sprint shows "shipped/total" format */
        var shipped = stats.sprintShipped != null ? stats.sprintShipped : 0;
        var total = stats.sprintTotal != null ? stats.sprintTotal : 0;
        if (!hasAnimatedCounters) {
          element.textContent = '0/' + total;
          /* Animate only the shipped portion */
          var target = shipped;
          var duration = 800;
          var startTime = null;
          function animSprint(currentTime) {
            if (!startTime) startTime = currentTime;
            var progress = Math.min((currentTime - startTime) / duration, 1);
            var eased = 1 - Math.pow(1 - progress, 3);
            element.textContent = Math.floor(eased * target) + '/' + total;
            if (progress < 1) {
              requestAnimationFrame(animSprint);
            } else {
              element.textContent = shipped + '/' + total;
            }
          }
          requestAnimationFrame(animSprint);
        } else {
          element.textContent = shipped + '/' + total;
        }
        return;
      }

      var val = f.value != null ? f.value : 0;
      if (!hasAnimatedCounters) {
        countUp(element, val, 800);
      } else {
        element.textContent = val;
      }
    });

    hasAnimatedCounters = true;
  }

  /* ================================================================
     RENDER: GRID Layers
     ================================================================ */

  function renderGridLayers(layers) {
    var container = document.getElementById('gridLayers');
    clearElement(container);

    LAYERS.forEach(function(layer, index) {
      var layerData = layers[layer.key] || {};
      var tasks = extractLayerTasks(layer.key, layerData);

      var card = el('div', 'layer-card');
      card.style.setProperty('--layer-color', layer.color);

      /* Staggered fade-in animation */
      setTimeout(function() {
        card.classList.add('visible');
      }, index * 50);

      /* --- Card header --- */
      var head = el('div', 'layer-head');

      var dot = el('span', 'layer-dot');
      dot.style.background = layer.color;
      head.appendChild(dot);

      var name = el('span', 'layer-name font-display', layer.num + ' ' + layer.name);
      head.appendChild(name);

      var stat = el('span', 'layer-stat');
      stat.textContent = buildLayerStatText(layer.key, layerData, tasks);
      head.appendChild(stat);

      card.appendChild(head);

      /* --- Task items (max 4 visible) --- */
      if (tasks.length === 0) {
        card.appendChild(el('div', 'layer-empty', 'No items'));
      } else {
        var itemsContainer = el('div', 'layer-items');
        var maxShow = 4;
        var shown = tasks.slice(0, maxShow);

        shown.forEach(function(task) {
          var row = document.createElement('div');
          row.className = 'layer-task';
          row.style.cursor = 'pointer';
          row.addEventListener('click', (function(t, lHex) {
            return function() { openAgentDrawer(t, lHex); };
          })(task, layer.hex));

          var taskDot = el('span', 'layer-task-dot');
          taskDot.style.background = task.statusColor || getStatusColor(task.status);
          row.appendChild(taskDot);

          row.appendChild(el('span', 'layer-task-name', task.name || 'Untitled'));

          if (task.status) {
            var pill = el('span', 'layer-task-status ' + getStatusPillClass(task.status), task.status);
            row.appendChild(pill);
          }

          itemsContainer.appendChild(row);
        });

        /* Show overflow count if more than 4 */
        if (tasks.length > maxShow) {
          var more = el('div', 'layer-task');
          more.style.justifyContent = 'center';
          var moreText = el('span', 'font-mono', '+' + (tasks.length - maxShow) + ' more');
          moreText.style.fontSize = '11px';
          moreText.style.color = 'var(--text-muted)';
          more.appendChild(moreText);
          itemsContainer.appendChild(more);
        }

        card.appendChild(itemsContainer);
      }

      container.appendChild(card);
    });
  }

  /**
   * Extract task arrays from different layer data shapes.
   * Each layer stores tasks differently in the API response.
   */
  function extractLayerTasks(key, data) {
    if (key === 'builder') {
      return [].concat(
        data.building || [],
        data.shipped || [],
        data.backlog || []
      );
    }
    if (key === 'pm') {
      return [].concat(
        data.sprintBoard || [],
        data.backlog || [],
        data.weeklyExec || []
      );
    }
    return data.items || [];
  }

  /**
   * Build descriptive stat text for a layer header.
   */
  function buildLayerStatText(key, data, tasks) {
    if (key === 'architect') {
      return (data.agentRegistry || tasks.length) + ' registered';
    }
    if (key === 'builder') {
      var building = (data.building || []).length;
      var shipped = (data.shipped || []).length;
      var bl = (data.backlog || []).length;
      return shipped + ' shipped, ' + building + ' active, ' + bl + ' backlog';
    }
    if (key === 'validator') {
      return (data.reviewQueue || 0) + ' review, ' + (data.systemHealth || 0) + ' health';
    }
    if (key === 'pm') {
      var sb = (data.sprintBoard || []).length;
      var bk = (data.backlog || []).length;
      return sb + ' sprint, ' + bk + ' backlog';
    }
    if (key === 'scout') {
      return (data.researchQueue || tasks.length) + ' research items';
    }
    if (key === 'librarian') {
      return tasks.length + ' items';
    }
    return tasks.length + ' items';
  }

  /* ================================================================
     RENDER: Build Pipeline
     ================================================================ */

  function renderPipeline(pipeline) {
    var container = document.getElementById('pipelineBody');
    clearElement(container);

    if (!pipeline || pipeline.length === 0) {
      container.appendChild(el('div', 'empty-message', 'No pipeline items'));
      return;
    }

    pipeline.forEach(function(task) {
      var row = document.createElement('div');
      row.className = 'pipeline-row';
      row.style.cursor = 'pointer';
      row.addEventListener('click', (function(t) {
        return function() { openAgentDrawer(t, null); };
      })(task));

      /* Priority dot */
      var priDot = el('span', 'pri-dot ' + getPriorityClass(task.priority));
      row.appendChild(priDot);

      /* Task name */
      row.appendChild(el('span', 'pipeline-name', task.name || 'Untitled'));

      /* Status pill */
      var pill = el('span', 'layer-task-status ' + getStatusPillClass(task.status), task.status || '--');
      row.appendChild(pill);

      /* Due date */
      var dateText = task.dueDate ? formatDate(task.dueDate) : '--';
      row.appendChild(el('span', 'pipeline-date', dateText));

      /* External link — opens ClickUp directly, stops drawer from opening */
      var linkWrap = document.createElement('a');
      linkWrap.className = 'pipeline-link';
      linkWrap.href = task.url || '#';
      linkWrap.target = '_blank';
      linkWrap.rel = 'noopener';
      linkWrap.addEventListener('click', function(e) { e.stopPropagation(); });
      var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class', 'pipeline-link-arrow');
      svg.setAttribute('viewBox', '0 0 24 24');
      var path1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      path1.setAttribute('x1', '7');
      path1.setAttribute('y1', '17');
      path1.setAttribute('x2', '17');
      path1.setAttribute('y2', '7');
      svg.appendChild(path1);
      var path2 = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
      path2.setAttribute('points', '7 7 17 7 17 17');
      svg.appendChild(path2);
      linkWrap.appendChild(svg);
      row.appendChild(linkWrap);

      container.appendChild(row);
    });
  }

  /* ================================================================
     RENDER: Recent Activity
     ================================================================ */

  function renderActivity(activity) {
    var container = document.getElementById('activityList');
    clearElement(container);

    if (!activity || activity.length === 0) {
      container.appendChild(el('div', 'empty-message', 'No recent activity'));
      return;
    }

    var items = activity.slice(0, 10);

    items.forEach(function(item) {
      var row = document.createElement('a');
      row.className = 'activity-item';
      row.href = item.url || '#';
      row.target = '_blank';
      row.rel = 'noopener';

      var dot = el('span', 'activity-dot');
      dot.style.background = item.statusColor || getStatusColor(item.status);
      row.appendChild(dot);

      var info = el('div', 'activity-info');
      info.appendChild(el('span', 'activity-name', item.name || 'Untitled'));

      if (item.status) {
        info.appendChild(el('span', 'activity-status-text', item.status));
      }

      row.appendChild(info);

      row.appendChild(el('span', 'activity-time', formatTimeAgo(item.dateUpdated)));

      container.appendChild(row);
    });
  }

  /* ================================================================
     RENDER: Content Pipeline
     ================================================================ */

  function renderContent(content) {
    var container = document.getElementById('contentSections');
    clearElement(container);

    var sections = [
      { label: 'TikTok Scripts', key: 'tiktokScripts', items: content.tiktokScripts || [] },
      { label: 'TikTok Takes',   key: 'tiktokTakes',   items: content.tiktokTakes || [] },
      { label: 'LinkedIn',       key: 'linkedin',       items: content.linkedin || [] }
    ];

    sections.forEach(function(section) {
      /* Section header with count badge */
      var headRow = el('div', 'content-section-head');
      headRow.appendChild(el('span', 'content-section-label', section.label));

      var badge = el('span', 'content-badge font-mono', String(section.items.length));
      headRow.appendChild(badge);

      container.appendChild(headRow);

      /* Items */
      if (section.items.length === 0) {
        var emptyRow = el('div', 'content-item');
        var emptyText = el('span', 'content-name', 'No items');
        emptyText.style.color = 'var(--text-muted)';
        emptyText.style.fontStyle = 'italic';
        emptyRow.appendChild(emptyText);
        container.appendChild(emptyRow);
        return;
      }

      var itemsWrap = el('div', 'content-items');

      section.items.forEach(function(item) {
        var row = document.createElement('a');
        row.className = 'content-item';
        row.href = item.url || '#';
        row.target = '_blank';
        row.rel = 'noopener';

        var dot = el('span', 'content-dot');
        dot.style.background = item.statusColor || getStatusColor(item.status);
        row.appendChild(dot);

        row.appendChild(el('span', 'content-name', item.name || 'Untitled'));

        if (item.status) {
          var statusEl = el('span', 'content-status ' + getStatusPillClass(item.status), item.status);
          row.appendChild(statusEl);
        }

        itemsWrap.appendChild(row);
      });

      container.appendChild(itemsWrap);
    });
  }

  /* ================================================================
     CHAT: localStorage persistence
     ================================================================ */

  function loadChatHistory() {
    try {
      var stored = localStorage.getItem(CONFIG.CHAT_STORAGE_KEY);
      if (stored) {
        var parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) return parsed;
      }
    } catch (e) { /* ignore */ }
    return [];
  }

  function saveChatHistory() {
    try {
      var trimmed = chatHistory.slice(-CONFIG.CHAT_MAX_HISTORY);
      localStorage.setItem(CONFIG.CHAT_STORAGE_KEY, JSON.stringify(trimmed));
    } catch (e) { /* ignore */ }
  }

  /* ================================================================
     CHAT: Dashboard context builder
     ================================================================ */

  function buildDashboardContext() {
    if (!dashboardData) return { available: false };
    var d = dashboardData;
    var s = d.stats || {};
    var ctx = {
      available: true,
      stats: s,
      layerSummary: {},
      buildPipeline: [],
      recentActivity: []
    };

    /* Layer summary */
    if (d.layers) {
      var la = d.layers;
      ctx.layerSummary = {
        architect: { count: la.architect ? (la.architect.agentRegistry || 0) : 0 },
        builder: {
          building: (la.builder && la.builder.building) ? la.builder.building.length : 0,
          shipped: (la.builder && la.builder.shipped) ? la.builder.shipped.length : 0,
          backlog: (la.builder && la.builder.backlog) ? la.builder.backlog.length : 0
        },
        validator: {
          reviewQueue: la.validator ? (la.validator.reviewQueue || 0) : 0,
          systemHealth: la.validator ? (la.validator.systemHealth || 0) : 0
        },
        pm: {
          sprintTotal: s.sprintTotal || 0,
          backlogTotal: (la.pm && la.pm.backlog) ? la.pm.backlog.length : 0
        },
        scout: { count: la.scout ? (la.scout.researchQueue || 0) : 0 }
      };
    }

    /* Build pipeline tasks */
    if (d.buildPipeline) {
      ctx.buildPipeline = d.buildPipeline.map(function(t) {
        return { name: t.name, status: t.status, priority: t.priority ? t.priority.priority || t.priority : null };
      });
    }

    /* Recent activity */
    if (d.recentActivity) {
      ctx.recentActivity = d.recentActivity.slice(0, 8).map(function(t) {
        return { name: t.name, status: t.status };
      });
    }

    return ctx;
  }

  /* ================================================================
     CHAT: Open / Close / Toggle
     ================================================================ */

  function openChat() {
    chatOpen = true;
    document.getElementById('chatFab').classList.add('hidden');
    var panel = document.getElementById('chatPanel');
    panel.classList.remove('hidden');
    renderChatMessages();
    var input = document.getElementById('chatInput');
    setTimeout(function() { input.focus(); }, 100);
  }

  function closeChat() {
    chatOpen = false;
    document.getElementById('chatPanel').classList.add('hidden');
    document.getElementById('chatFab').classList.remove('hidden');
  }

  function toggleChat() {
    if (chatOpen) closeChat();
    else openChat();
  }

  /* ================================================================
     CHAT: Render messages
     ================================================================ */

  function renderChatMessages() {
    var container = document.getElementById('chatMessages');
    clearElement(container);

    if (chatHistory.length === 0) {
      renderWelcome(container);
      return;
    }

    chatHistory.forEach(function(msg) {
      appendMessageBubble(container, msg.role, msg.content, msg.timestamp);
    });
    scrollChatBottom();
  }

  function renderWelcome(container) {
    var wrap = el('div', 'chat-welcome');
    wrap.appendChild(el('div', 'chat-welcome-title font-display', 'GRID Agent'));
    wrap.appendChild(el('div', 'chat-welcome-desc', 'Ask me anything about your agent pipeline, sprint status, or build progress.'));

    var chips = el('div', 'chat-suggestions');
    var suggestions = [
      'What\'s the build pipeline status?',
      'How many agents are shipped?',
      'What\'s blocking progress?',
      'Sprint velocity summary'
    ];
    suggestions.forEach(function(text) {
      var chip = el('div', 'chat-chip', text);
      chip.addEventListener('click', function() {
        document.getElementById('chatInput').value = text;
        sendChatMessage();
      });
      chips.appendChild(chip);
    });
    wrap.appendChild(chips);
    container.appendChild(wrap);
  }

  function appendMessageBubble(container, role, content, timestamp) {
    var bubble = el('div', 'chat-msg ' + (role === 'human' ? 'chat-msg-human' : 'chat-msg-agent'));

    var contentEl = el('div', 'chat-msg-content');
    if (role === 'agent') {
      /* Basic markdown: bold **text** */
      contentEl.innerHTML = escapeHtml(content)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    } else {
      contentEl.textContent = content;
    }
    bubble.appendChild(contentEl);

    if (timestamp) {
      var time = new Date(timestamp);
      var timeStr = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
      bubble.appendChild(el('div', 'chat-msg-time', timeStr));
    }

    container.appendChild(bubble);
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function scrollChatBottom() {
    var msgs = document.getElementById('chatMessages');
    setTimeout(function() { msgs.scrollTop = msgs.scrollHeight; }, 50);
  }

  /* ================================================================
     CHAT: Send message
     ================================================================ */

  function sendChatMessage() {
    var input = document.getElementById('chatInput');
    var text = input.value.trim();
    if (!text || chatSending) return;

    chatSending = true;
    var sendBtn = document.getElementById('chatSend');
    sendBtn.disabled = true;
    input.disabled = true;

    /* Add human message */
    var now = new Date().toISOString();
    chatHistory.push({ role: 'human', content: text, timestamp: now });
    saveChatHistory();

    /* Clear welcome if showing */
    var welcome = document.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    /* Render human bubble */
    var container = document.getElementById('chatMessages');
    appendMessageBubble(container, 'human', text, now);

    /* Clear input */
    input.value = '';
    input.style.height = '';

    /* Show typing indicator */
    var typing = el('div', 'chat-typing');
    typing.appendChild(document.createElement('span'));
    typing.appendChild(document.createElement('span'));
    typing.appendChild(document.createElement('span'));
    container.appendChild(typing);
    scrollChatBottom();

    /* Build payload */
    var payload = {
      token: CONFIG.CHAT_TOKEN,
      message: text,
      conversationHistory: chatHistory.slice(-10),
      dashboardContext: buildDashboardContext()
    };

    /* POST to n8n */
    fetch(CONFIG.CHAT_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function(resp) {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return resp.json();
    })
    .then(function(data) {
      if (Array.isArray(data)) data = data[0];
      var reply = (data && data.reply) ? data.reply : 'Sorry, I could not process that request.';

      chatHistory.push({ role: 'agent', content: reply, timestamp: new Date().toISOString() });
      saveChatHistory();

      if (typing.parentNode) typing.remove();
      appendMessageBubble(container, 'agent', reply, new Date().toISOString());
      scrollChatBottom();
    })
    .catch(function(err) {
      var errMsg = 'Sorry, I encountered an error. The chat workflow may not be active yet. Please check n8n.';
      chatHistory.push({ role: 'agent', content: errMsg, timestamp: new Date().toISOString() });
      saveChatHistory();

      if (typing.parentNode) typing.remove();
      appendMessageBubble(container, 'agent', errMsg, new Date().toISOString());
      scrollChatBottom();
    })
    .finally(function() {
      chatSending = false;
      sendBtn.disabled = false;
      input.disabled = false;
      input.focus();
    });
  }

  /* ================================================================
     CHAT: Auto-resize textarea
     ================================================================ */

  function autoResizeInput() {
    var input = document.getElementById('chatInput');
    input.style.height = '';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  }

  /* ================================================================
     DRAWER: Open / Close
     ================================================================ */

  function openAgentDrawer(taskData, layerHex) {
    currentDrawerTask = taskData;
    var header = document.getElementById('drawerHeader');
    header.style.setProperty('--drawer-accent', layerHex || 'var(--mint)');

    /* Set title and layer badge */
    document.getElementById('drawerTitle').textContent = taskData.name || 'Untitled';
    var badge = document.getElementById('drawerLayerBadge');
    if (layerHex) {
      var found = LAYERS.filter(function(l) { return l.hex === layerHex; });
      badge.textContent = found.length ? found[0].num + ' ' + found[0].name : '';
      badge.style.color = layerHex;
    } else {
      badge.textContent = '';
    }

    /* ClickUp link */
    document.getElementById('drawerClickupLink').href = taskData.url || '#';

    /* Render basic fields from client-side data */
    renderDrawerBasicFields(taskData);

    /* Show drawer */
    document.getElementById('drawerBackdrop').classList.remove('hidden');
    document.getElementById('agentDrawer').classList.remove('hidden');

    /* Fetch enriched data from n8n */
    fetchAgentDetail(taskData.id);
  }

  function closeAgentDrawer() {
    var drawer = document.getElementById('agentDrawer');
    var backdrop = document.getElementById('drawerBackdrop');
    drawer.classList.add('closing');
    setTimeout(function() {
      drawer.classList.add('hidden');
      drawer.classList.remove('closing');
      backdrop.classList.add('hidden');
      currentDrawerTask = null;
    }, 200);
  }

  /* ================================================================
     DRAWER: Render basic fields (instant, from client data)
     ================================================================ */

  function renderDrawerBasicFields(task) {
    var body = document.getElementById('drawerBody');
    clearElement(body);

    /* Status */
    var statusField = el('div', 'drawer-field');
    statusField.appendChild(el('div', 'drawer-label', 'STATUS'));
    var statusBadge = el('span', 'drawer-status ' + getStatusPillClass(task.status), task.status || 'unknown');
    var sv = el('div', 'drawer-value');
    sv.appendChild(statusBadge);
    statusField.appendChild(sv);
    body.appendChild(statusField);

    /* Priority */
    if (task.priority) {
      var priField = el('div', 'drawer-field');
      priField.appendChild(el('div', 'drawer-label', 'PRIORITY'));
      var priVal = el('div', 'drawer-priority');
      var priDot = el('span', 'drawer-pri-dot');
      var priName = typeof task.priority === 'object' ? (task.priority.priority || 'normal') : task.priority;
      var priColors = { urgent: '#F87171', high: '#FBBF24', normal: '#64748B', low: '#475569' };
      priDot.style.background = priColors[priName] || '#64748B';
      priVal.appendChild(priDot);
      priVal.appendChild(document.createTextNode(priName));
      priField.appendChild(priVal);
      body.appendChild(priField);
    }

    /* Assignees */
    if (task.assignees && task.assignees.length > 0) {
      var assField = el('div', 'drawer-field');
      assField.appendChild(el('div', 'drawer-label', 'ASSIGNEES'));
      var assWrap = el('div', 'drawer-assignees');
      task.assignees.forEach(function(a) {
        var name = typeof a === 'string' ? a : (a.username || a.email || 'Unknown');
        assWrap.appendChild(el('span', 'drawer-assignee-chip', name));
      });
      assField.appendChild(assWrap);
      body.appendChild(assField);
    }

    /* Dates */
    var datesField = el('div', 'drawer-field');
    datesField.appendChild(el('div', 'drawer-label', 'DATES'));
    var datesGrid = el('div', 'drawer-dates');

    var pairs = [
      ['Created', task.dateCreated],
      ['Updated', task.dateUpdated],
      ['Due', task.dueDate]
    ];
    pairs.forEach(function(pair) {
      if (pair[1]) {
        var cell = el('div', '');
        cell.appendChild(el('div', 'drawer-label', pair[0]));
        cell.appendChild(el('div', 'drawer-value font-mono', formatDate(pair[1])));
        datesGrid.appendChild(cell);
      }
    });
    datesField.appendChild(datesGrid);
    body.appendChild(datesField);

    /* Loading placeholder for enriched data */
    var loadingField = el('div', 'drawer-field');
    loadingField.id = 'drawerEnriched';
    var sk1 = el('div', 'drawer-skeleton'); sk1.style.width = '80%'; sk1.style.marginBottom = '8px';
    var sk2 = el('div', 'drawer-skeleton'); sk2.style.width = '60%'; sk2.style.marginBottom = '8px';
    var sk3 = el('div', 'drawer-skeleton'); sk3.style.width = '70%';
    loadingField.appendChild(sk1);
    loadingField.appendChild(sk2);
    loadingField.appendChild(sk3);
    body.appendChild(loadingField);
  }

  /* ================================================================
     DRAWER: Fetch enriched data from n8n
     ================================================================ */

  function fetchAgentDetail(taskId) {
    if (!taskId) return;
    var url = CONFIG.DETAIL_WEBHOOK_URL + '?token=' + CONFIG.CHAT_TOKEN + '&taskId=' + taskId;

    fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } })
      .then(function(resp) {
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.json();
      })
      .then(function(data) {
        if (Array.isArray(data)) data = data[0];
        renderDrawerEnrichedFields(data);
      })
      .catch(function(err) {
        var enriched = document.getElementById('drawerEnriched');
        if (enriched) {
          clearElement(enriched);
          enriched.appendChild(el('div', 'drawer-value', 'Detail unavailable — check n8n workflow.'));
          enriched.style.color = 'var(--text-muted)';
          enriched.style.fontSize = '12px';
        }
      });
  }

  /* ================================================================
     DRAWER: Render enriched data (description, subtasks, tags)
     ================================================================ */

  function renderDrawerEnrichedFields(data) {
    var enriched = document.getElementById('drawerEnriched');
    if (!enriched) return;
    clearElement(enriched);

    /* Description */
    if (data.description && data.description.trim()) {
      var descField = el('div', 'drawer-field');
      descField.appendChild(el('div', 'drawer-label', 'DESCRIPTION'));
      var desc = el('div', 'drawer-desc');
      desc.textContent = data.description.substring(0, 1000);
      descField.appendChild(desc);
      enriched.appendChild(descField);
    }

    /* Tags */
    if (data.tags && data.tags.length > 0) {
      var tagField = el('div', 'drawer-field');
      tagField.appendChild(el('div', 'drawer-label', 'TAGS'));
      var tagWrap = el('div', 'drawer-tags');
      data.tags.forEach(function(t) {
        tagWrap.appendChild(el('span', 'drawer-tag', t));
      });
      tagField.appendChild(tagWrap);
      enriched.appendChild(tagField);
    }

    /* Subtasks */
    if (data.subtasks && data.subtasks.length > 0) {
      var subField = el('div', 'drawer-field');
      subField.appendChild(el('div', 'drawer-label', 'SUBTASKS (' + data.subtasks.length + ')'));
      var subList = el('div', 'drawer-subtasks');

      data.subtasks.forEach(function(st) {
        var row = el('div', 'drawer-subtask');
        var dot = el('span', 'drawer-sub-dot');
        dot.style.background = st.statusColor || getStatusColor(st.status);
        row.appendChild(dot);
        row.appendChild(el('span', 'drawer-sub-name', st.name || 'Untitled'));
        var stPill = el('span', 'drawer-sub-status ' + getStatusPillClass(st.status), st.status || '--');
        row.appendChild(stPill);
        subList.appendChild(row);
      });

      subField.appendChild(subList);
      enriched.appendChild(subField);
    }

    /* Additional metadata */
    if (data.list || data.folder) {
      var locField = el('div', 'drawer-field');
      locField.appendChild(el('div', 'drawer-label', 'LOCATION'));
      var locText = [data.folder, data.list].filter(Boolean).join(' → ');
      locField.appendChild(el('div', 'drawer-value', locText));
      enriched.appendChild(locField);
    }

    if (data.timeEstimate) {
      var teField = el('div', 'drawer-field');
      teField.appendChild(el('div', 'drawer-label', 'TIME ESTIMATE'));
      var hours = Math.floor(data.timeEstimate / 3600000);
      var mins = Math.floor((data.timeEstimate % 3600000) / 60000);
      teField.appendChild(el('div', 'drawer-value font-mono', hours + 'h ' + mins + 'm'));
      enriched.appendChild(teField);
    }

    /* If nothing enriched, show minimal message */
    if (enriched.children.length === 0) {
      enriched.appendChild(el('div', 'drawer-value', 'No additional details available.'));
      enriched.style.color = 'var(--text-muted)';
      enriched.style.fontSize = '12px';
    }
  }

  /* ================================================================
     EVENT BINDINGS
     ================================================================ */

  document.getElementById('refreshBtn').addEventListener('click', function() {
    manualRefresh();
  });

  /* Chat */
  document.getElementById('chatFab').addEventListener('click', toggleChat);
  document.getElementById('chatClose').addEventListener('click', closeChat);
  document.getElementById('chatSend').addEventListener('click', sendChatMessage);
  document.getElementById('chatInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChatMessage();
    }
  });
  document.getElementById('chatInput').addEventListener('input', autoResizeInput);

  /* Drawer */
  document.getElementById('drawerClose').addEventListener('click', closeAgentDrawer);
  document.getElementById('drawerBackdrop').addEventListener('click', closeAgentDrawer);
  document.getElementById('drawerAskBtn').addEventListener('click', function() {
    var title = document.getElementById('drawerTitle').textContent;
    closeAgentDrawer();
    setTimeout(function() {
      openChat();
      document.getElementById('chatInput').value = 'Tell me about: ' + title;
      document.getElementById('chatInput').focus();
    }, 250);
  });

  /* Global Escape key */
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      var drawer = document.getElementById('agentDrawer');
      if (!drawer.classList.contains('hidden')) {
        closeAgentDrawer();
      } else if (chatOpen) {
        closeChat();
      }
    }
  });

  /* ================================================================
     INITIALIZATION
     ================================================================ */

  chatHistory = loadChatHistory();
  fetchDashboardData();
  refreshTimer = setInterval(fetchDashboardData, CONFIG.REFRESH_INTERVAL);

})();
</script>

</body>
</html>
